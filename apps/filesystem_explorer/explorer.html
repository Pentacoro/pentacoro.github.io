<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * {
            box-sizing: border-box;
            font-family: "Gotham", "Helvetica Neue", Helvetica, Arial, "sans-serif";
            margin: 0;
        }
        .container.ID_TASKID {
            position: absolute;
            display: grid;
            grid-template-rows: 40px auto;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        .nav.ID_TASKID {
            position: sticky;
            top: 0px;
            height: 40px;
            width: 100%;

            display: grid;
            grid-template-columns: 40px 40px 40px auto 40px;
            background-color: rgb(195, 203, 221);
            z-index: 100;
        }
        .nav.ID_TASKID>button{
            background-color: rgb(195, 203, 221);
            border: 0px;
            font-size: 1.4em;
            color: rgb(90, 108, 126);
            cursor: pointer;
        }
        .nav.ID_TASKID>.back:active , .nav.ID_TASKID>.forth:active{
            color: rgb(123, 140, 156);
        }
        .nav.ID_TASKID>.back:hover , .nav.ID_TASKID>.forth:hover{
            background-color: rgb(207, 213, 228);
        }
        .nav.ID_TASKID>.parent:active , .nav.ID_TASKID>.refresh:active{
            color: rgb(123, 140, 156);
        }
        .nav.ID_TASKID>.parent{
            background-color: rgb(174, 183, 204);
        }
        .nav.ID_TASKID>.refresh{
            background-color: rgb(174, 183, 204);
        }
        .nav.ID_TASKID>.addressBox{
            background-color: white;
            border: 3px solid rgb(174, 183, 204);
            cursor: text;

            display: flex;
            align-items: center;
            justify-content: left;
            padding-left: .5em;
            width: 100%;
            height: 100%;

            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }
        .addressBox.ID_TASKID>.address{
            background-color: white;
            color: rgb(167, 167, 167);
            cursor: text;
            font-size: 1.1em;
        }
        /*---------------------------------------*/
        .background.ID_TASKID {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: auto;
        }
        .list.ID_TASKID {
            width: 100%;
            height: 100%;
            
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: flex-start;
            align-content: flex-start;
            gap: 5px;
            padding: 5px;
        }
        .list>.explorerIcon.ID_TASKID {
            margin: 0px;
            z-index: 10;

            width: 80px;
            height: 110px;

            border: 2px dotted rgba(255, 255, 255, 0);
        }
        .list>.explorerIcon.active.ID_TASKID {
            background-color: rgba(111, 161, 228, 0.623);
            border: 2px solid rgba(0, 0, 0, 0.08);
        }
        .list>.explorerIcon.ID_TASKID:hover {
            border: 2px dotted rgba(0, 0, 0, 0.15);
        }
        .list>.explorerIcon.highlight.ID_TASKID {
            border: 2px dotted rgba(0, 0, 0, 0.39);
        }

        /*---------------------------------------*/
        .explorerIconImage.ID_TASKID{
            width: 100%;
            height: 50%;
            margin: 7px auto;
            background-image: url("../assets/svg/desktopIcons/folderPlaceholder.svg");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;

            -webkit-filter: drop-shadow(0px 1px 2px rgb(0,0,0,.5));
            filter: drop-shadow(0px 1px 2px rgb(0,0,0,.5));
        }
        .explorerIconText.ID_TASKID{
            display: block;
            text-align: center;
            color: rgb(56, 56, 56);
            max-height: 2.35em;
            width: 100%;

            hyphens: auto;
            overflow: hidden;
            text-overflow: ellipsis;
            word-wrap: break-word;
        }
        /*---------------------------------------*/
    </style>

    <title>Explorer</title>
</head>
<body>

    <div class="container ID_TASKID">

        <div class="nav ID_TASKID">
            <button class="back ID_TASKID">◀</button>
            <button class="forth ID_TASKID">▶</button>
            <button class="parent ID_TASKID">▲</button>

            <div class="addressBox ID_TASKID">
                <span class="address ID_TASKID">xcorex</span>
            </div>

            <button class="refresh ID_TASKID">⭮</button>
        </div>

            <div class="background ID_TASKID">
                <div class="list ID_TASKID">

                </div>
            </div>

    </div>

    <script>  
        let task = findTask("TASKID")
        let mem  = findTask("TASKID").memory
        task.apps = "exp"
        mem.iconArray = []
        mem.variables = {}
        mem.directory = "xcorex"

        mem.explorerInit = function (dir, id, act = null) {    
            try {       
                let activeObj = addressInterpreter(dir)
                let dirList   = Object.entries(activeObj.cont)

                let dirFolder = []
                let dirFile   = []
                let dirTran   = []

                for (icon of findTask(id).memory.iconArray){
                    document.getElementsByClassName("list ID_"+id)[0].removeChild(icon.node)
                }

                findTask(id).memory.iconArray = []
                findTask(id).memory.directory = dir
                findTask(id).memory.variables.dirname = activeObj.name
                findTask(id).pocket = []

                for (item of dirList) {
                    if(item[1].conf.type === "dir" && !item[1].conf.tran) {
                        dirFolder.push(item[1])
                    }
                }
                for (item of dirList) {
                    if(item[1].conf.type !=  "dir") {
                        dirFile.push(item[1])
                    }
                }
                for (item of dirList) {
                    if(item[1].conf.tran) {
                        dirTran.push(item[1])
                    }
                }

                dirFolder.sort((a, b) => a.name.localeCompare(b.name))
                dirFile.sort  ((a, b) => a.name.localeCompare(b.name))
                dirTran.sort  ((a, b) => a.name.localeCompare(b.name))

                document.getElementsByClassName("address ID_"+id)[0].innerHTML = dir
                document.getElementsByClassName("window ID_"+id)[0].children[0].children[0].children[0].innerHTML = activeObj.name

                createExplorerIcons(dirFolder)
                createExplorerIcons(dirFile)
                createExplorerIcons(dirTran)
            } catch (e) {
                mem.variables.error = e
                mem.variables.errorB = [["Okay", endTask]]
                loadAPP("./apps/system_popup/popup_lau.html",["Error",false,"Couldn't load directory", "This directory seems to no longer exist. It might have been moved, or a parent directory been renamed","TASKID",""])

                if (act === "refresh") mem.explorerInit("", "TASKID")
            }
        }

        mem.explorerInit("xcorex", "TASKID")

        //nav buttons
        document.getElementsByClassName("back ID_TASKID")[0].onclick = e => {

        }
        document.getElementsByClassName("parent ID_TASKID")[0].onclick = e => {
            if (mem.directory !== "") {
                try {
                    mem.explorerInit(addressInterpreter(mem.directory).conf.from, "TASKID")
                } catch (e1) {
                    try {
                        let newDir = mem.directory.replace(/\/(?:.(?!\/))+$/gim, "")
                        mem.explorerInit(newDir, "TASKID")
                    } catch (e) {
                        mem.variables.error  = e
                        mem.variables.errorB = [["Okay", endTask]]
                        loadAPP("./apps/system_popup/popup_lau.html",["Error",false,"Couldn't load directory", "This directory seems to no longer exist. It might have been moved, or a parent directory been renamed","TASKID",""])

                        mem.explorerInit("", "TASKID")
                    }
                }
            } else {
                mem.explorerInit(mem.directory, "TASKID")
            }
        }
        document.getElementsByClassName("refresh ID_TASKID")[0].onclick = e => {
            mem.explorerInit(mem.directory, "TASKID", "refresh")
        }
        document.getElementsByClassName("list ID_TASKID")[0].onmousedown = e => {
            if (e.target.classList.contains("list")) {
                for (icon of task.pocket) {
                    icon.statNode(0)
                    task.pocket = task.pocket.remove(icon)
                }
            }
        }
        document.getElementsByClassName("list ID_TASKID")[0].oncontextmenu = e => {
            if (e.target.classList.contains("list")) {
                openMenu(e, task)
            }
        }

        //local functions
        function createExplorerIcons(array) {
                for(item of array) {
                    let itemIcon = item.conf.icon
                    let dirIcon  = new IconDir(itemIcon.imag, itemIcon.text, "TASKID", itemIcon.apps, itemIcon.file)
                    mem.iconArray.push(dirIcon)
                    
                    dirIcon.createNode()
            }
        }
    </script>
</body>
</html>